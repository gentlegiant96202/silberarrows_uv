# Lease Accounting Module

A comprehensive accounting system for managing financial transactions in active car leases.

## Features

### ðŸ“Š Charge Management
- **Add Charges**: One-click charge creation with inline editing
- **Charge Types**: Monthly rental, Salik, excess mileage, late fees, traffic fines
- **Auto-calculation**: Quantity Ã— unit price for variable charges
- **Comments**: Optional notes for each charge (e.g., "customer requested extension")

### ðŸ“… Billing Periods
- **Monthly Cycles**: Automatically generated based on lease start date
- **Period Forecast**: View upcoming billing periods
- **Status Tracking**: Pending, active, invoiced, paid, overdue
- **Quick Actions**: Add charges and generate invoices per period

### ðŸ§¾ Invoice Generation
- **Auto-generation**: Group charges by billing period into invoices
- **VAT Handling**: Default 5% VAT with toggle on/off capability
- **Professional Layout**: Clean invoice preview with all charge details
- **Due Date Management**: Configurable payment terms

### ðŸ’³ Payment Processing
- **Multiple Methods**: Cash, card, bank transfer, cheque
- **Partial Allocation**: Distribute payments across multiple invoices
- **Payment Tracking**: Reference numbers and notes
- **Auto-allocation**: Smart payment distribution

### ðŸ“‹ Statement of Account
- **Chronological View**: Bank statement-style transaction history
- **Running Balance**: Real-time balance calculations
- **Filtering**: Date range and transaction type filters
- **Export Ready**: PDF export functionality (coming soon)

## Database Schema

Single table approach using `lease_accounting`:

```sql
CREATE TABLE lease_accounting (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lease_id UUID NOT NULL,
    billing_period DATE NOT NULL,
    charge_type charge_type_enum NOT NULL,
    quantity NUMERIC NULL,
    unit_price NUMERIC NULL,
    total_amount NUMERIC NOT NULL,
    comment TEXT NULL,
    invoice_id UUID NULL,
    payment_id UUID NULL,
    status accounting_status_enum NOT NULL DEFAULT 'pending',
    vat_applicable BOOLEAN NOT NULL DEFAULT true,
    account_closed BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Components

### `LeaseAccountingDashboard`
Main dashboard with tabbed interface for all accounting functions.

**Props:**
- `leaseId`: UUID of the lease
- `leaseStartDate`: Start date for billing period calculation
- `customerName`: Display name for the customer
- `onClose`: Callback when dashboard is closed

### `AccountingButton`
Simple button component to launch the accounting dashboard.

**Usage:**
```tsx
import { AccountingButton } from '@/components/modules/leasing/accounting';

<AccountingButton
  leaseId={lease.id}
  leaseStartDate={lease.lease_start_date}
  customerName={lease.customer_name}
/>
```

### `BillingPeriodsView`
Displays billing periods with charges grouped by month.

### `InvoiceModal`
Modal for generating invoices with VAT controls and preview.

### `PaymentModal`
Modal for recording payments and allocating them to invoices.

### `StatementOfAccount`
Comprehensive statement view with filtering and export options.

## Integration

To integrate with the Active Lease column in the Kanban board:

1. Import the AccountingButton component
2. Add it to the lease card actions
3. Pass the required lease data

```tsx
import { AccountingButton } from '@/components/modules/leasing/accounting';

// In your lease card component
<AccountingButton
  leaseId={customer.id}
  leaseStartDate={customer.lease_start_date}
  customerName={customer.customer_name}
  className="w-full"
/>
```

## Data Flow

1. **Charges** are added to specific billing periods
2. **Invoices** are generated by grouping charges from a billing period
3. **Payments** are recorded and allocated against invoices
4. **Statement** shows chronological view of all transactions
5. **Balance** is calculated as running total of debits minus credits

## Status Management

- **pending**: Charge created but not invoiced
- **invoiced**: Charge included in an invoice
- **paid**: Charge fully paid
- **overdue**: Invoice past due date

## Future Enhancements

- PDF export for statements and invoices
- Email invoice delivery
- Automated recurring charges
- Late fee automation
- Integration with external payment gateways
- Bulk payment import
- Advanced reporting and analytics
